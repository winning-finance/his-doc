<!--
 * @Author: smallalso<hu141418@gmail.com>
 * @Date: 2020-12-15 14:48:08
 * @LastEditors: smallalso<hu141418@gmail.com>
 * @LastEditTime: 2020-12-16 15:32:59
 * @FilePath: /his-doc/docs/guide/introduction.md
-->
## 本地开发

本节将介绍如何在本地开发调试his项目。

### 问题

在现有方案确定之前，我们的项目基本都是使用 `vue-cli` 生成的spa项目，基本是 `vue` 项目开发必用，非常完善，配置也很简单。但在确定了使用微前端的解决方案之后，带来了两个概念：`主应用` 和 `子应用`，主应用只有一个，大部分时候我们开发的业务模块都是子应用，子应用也是由主应用加载的，那么问题来了：

**本地开时如何实现子应用、主应用相结合**


### 方案一

npm包方式，目前不推荐使用

#### 项目结构
```
├── packages                          # 子应用集合
│   ├── module1                       # 子应用1
│   │   └── src                       # 子应用源码
│   │
│   ├── module2                       # 子应用2
│   └── ...                           # 其他子应用
│                
├── src                               # 子应用之间通用模块
│   ├── components                    # 通用组件
│   └── ...                           # 其他通用模块
├── service.config.js                 # 配置文件
```

该方案通过 `lerna` 将多个子应用集合在一个git仓库中，每个子应用完全独立，都拥有自己都 serve、build 等命令，子应之间公用的模块放在根目录 __src__ 文件夹下，默认配置 __@@__ 指向该文件夹。

在该方案下，多个子项目就有多个`serve`命令，所以本地默认会启动多个serve, 那么核心的主应用在哪里呢，在npm包里，没错，`web-his-main` 会作为本地开发的依赖被下载，本地开发时默认会启动 web-his-main 的 serve 命令 和 packages 文件夹下所有的 serve 命令。

这样，主项目和子项目都有了，然后通过 service.config.js 中的 menu 配置将子项目项目的入口文件换成 本地子项目  serve 入口，这样就完成了主应用和子应用的结合。

### 方案一升级版

方案一完美的解决了本地开发子应用、主应用相结合的问题。但是随着使用，也存在诸多问题：

- 为保持 web-his-main 更新，必须频繁同步最新 npm 包
- 依赖管理比较麻烦，packages 下每个模块都要管理依赖（package.jsons）
- 最要命的是 lerna 如果使用不规范，在公司CI平台经常有同事构建出错
- 构建时间较长
- 本地开发占用内存，起太多服务
- 项目根目录下src文件无法配置 eslint ,使用lint 自动修复规范问题

为此，我们改变了

- webpack 打包方式，改单入口为多入口
- 放弃npm包的方式，直接使用代理的方式，代理到线上最新的 his-main

升级版的核心原理就是这两条

#### 项目结构
```
├── src                          # 源码
│   ├── modules                  # 子应用集合
│   │   ├── m1                   # 子应用1
│   │   │   ├── components       # 子应用1组件
│   │   │   ├── main.js          # 子应用1 入口文件，（非常重要）                   
│   │   │   └── ...              # 子应用1 其他模块
│   │   └── ...                   # 其他子应用
│   │
│   ├── components                       # 通用组件
│   └── ...                              # 其他通用模块
│                
├── public                               # 子应用之间通用模                           
├── service.config.js                 # 配置文件
```

该方案改变了构建打包的方式，通过读取 文件 `src/modules/**/main.js` 作为 webpack 打包的入口文件，实现了本地单个 serve,就能访问到所有子应用，同时本地之间代理到his-main, 不需要本地再起主应用。
